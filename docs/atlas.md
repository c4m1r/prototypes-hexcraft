# Атлас проекта

На старте проекта рендер мира выполняется через Three.js и Vite, все материалы и шейдеры привязаны к единым `HEX_SIZE/HEX_RADIUS`, описанным в `src/utils/hexUtils.ts`. Объекты создаются как `CylinderGeometry` с шестью сегментами и рендерятся через `InstancedMesh`, поэтому каждый блок оказывает минимальную нагрузку. Основной пайплайн:

1. **Генерация мира** (`ChunkGenerator`):
   - Гексагональная сетка (`hexToWorld`, `worldToHex`) рассчитывается по формуле pointy-top: `x = size * √3 * (q + r/2)` и `z = size * 1.5 * r`, где `size = HEX_SIZE = HEX_RADIUS = 1`.
   - Поверхность строится по шуму и `BiomeConfig`; деревья, additional grass, структуры и подготовка `blockMap` выполняются до рендера.
   - Структуры (`foo`, cave tunnel, wooden platform, darkforest trees, aether structures) добавляются в `blocks`, сразу синхронизируются с `blockMap`, чтобы избежать наложений и конфликта с деревьями.
2. **Текстуры** загружаются через `TextureManager` из `src/game/texutres.png` (320×320, плитки по 32×32). Для dual-текстурных блоков (например, `grass`) материалы создаются через шейдер, использующий `topTexture` и `sideTexture`.
3. **Формулы и сложности**: рендер требует синхронизации UV с атласом (для hex-геометрии top/side differ); критичный момент — прозрачность (`alphaTest`) настроена только для специальных блоков (`water`, `ice`, `leaves`, `aetherleaf`), а `grass` теперь всегда непрозрачный.

## Используемые технологии

- `Vite 5.4.8` + ESBuild для сборки — нужен актуальный `browserslist-db`.
- `Three.js` для рендеринга инстансов.
- Хэш-карта `blockMap` для быстрой проверки соседей/видимости.
- `instancedMeshPool` и `globalMatrixPool` уменьшают GC.
- `docs/structures.md` описывает текущие шаблоны и новые блоки.

## Атлас текстур

Действующий атлас:

| Ряд | Колонка | Назначение | Тип | Примечания |
|-----|---------|------------|-----|------------|
| 0 | 0 | grass-top | верх | Верх травы |
| 0 | 1 | grass | бок | `grass` (верх+низ) |
| 0 | 2 | dirt | верх/бок | Земля |
| 0 | 3 | stone | верх/бок | Камень |
| 0 | 4 | sand | верх/бок | Песок |
| 0 | 5 | snow | верх/бок | Снег |
| 0 | 6 | ice | верх/бок | Лёд (текущий alpha=0.5) |
| 0 | 7 | bronze | верх/бок | Ресурс |
| 0 | 8 | silver | верх/бок | Ресурс |
| 0 | 9 | gold | верх/бок | Ресурс |
| 1 | 0-2 | lava1-3 | анимация | Лава, 3 кадра |
| 1 | 3-5 | water1-3 | анимация | Вода |
| 2 | 0 | wood | верх/бок | Ствол |
| 2 | 1 | leaves | верх/бок | Листва (прозр. 0.75) |
| 3 | 0 | red mushroom | верх/бок | |
| 3 | 1 | mushroom | верх/бок | |
| 3 | 2 | spruce | верх/бок | Ствол тёмного леса |
| 3 | 3 | pine | верх/бок | Хвоя (прозр. 0.85) |
| 3 | 4 | foo | верх/бок | Маркер структуры |
| 3 | 5 | aethergrass-top | верх | Aethergrass |
| 3 | 6 | aethergrass | бок | Aethergrass sides |
| 3 | 7 | aether | верх/бок | Aether блок |
| 3 | 8 | crystal | верх/бок | Кристаллическая руда |
| 3 | 9 | aetherwood | верх/бок | Ствол Aether-дерева |
| 3 |10 | aetherstone | верх/бок | Aether-камень |
| 3 |11 | aetherleaf | верх/бок | Листва Aether (alpha 0.4) |

### Работа с UV

- Для `grass` и `foo` применяются разные топ/боковые текстуры через `createDualTextureMaterial`.
- Все UV строятся из атласа `rows=4`, `cols=12`; `getUVCoordinates` возвращает `(u,v,uSize,vSize)` без инверсии, потому что `TextureLoader` уже заботится о `flipY`.
- `aetherleaf` и другие прозрачные блоки используют `transparent=true` и `alpha≈0.4`.
- `TextureManager` исправляет артефакты альфа при создании `DataTexture`.

## Зоны и структуры

### Биомы

| Биом | Поверхность | Подспойка | Особенности |
|------|-------------|-----------|-------------|
| grassland | `grass` | `dirt` → `stone` | Базовая область с деревьями/грибами, `treeMultiplier=0.7`. |
| darkforest | `grass` | как grassland | Требует 4 соседних `grassland`, плотность деревьев повышена `treeMultiplier=1.3`, ствол — `spruce`, хвоя — `pine`. |
| desert | `sand` | `sand` → `stone` | Без деревьев. |
| snow | `snow` | `snow` → `stone` | Холодные районы. |
| frozen | `ice` | `ice` → `stone` | Ледяные районы. |
| aether | `aethergrass` | `aethergrass` → `aetherstone`/`crystal` | Подземье промаркировано `crystal` и `aetherstone`; деревья состоят из `aetherwood`/`aetherleaf`. |
| stone | `stone` | `stone` | Горные районы, кроме Aether. |

### Структуры (из `docs/structures.md`)

1. **foo structure** — центральный блок `foo` с шестью соседями, используется как маркер/платформа/декор. Применяется в дебаге и сложных структурах.
2. **Cave tunnel** — путь из `foo` под поверхностью (`surfaceHeight - 2`), длиной ~6 гексагонов в случайных направлениях, помогает визуализировать пещеры.
3. **Wood platform** — плоская площадка радиуса 2, центр `foo`, внешние блоки `wood`. Используется как платформа/приграничная структура.
4. **Dark Forest trees** — лишние условия: деревья появляются только внутри `darkforest` между `grassland`. Ствол `spruce`, хвоя `pine`.
5. **Aether biome structures** — деревья из `aetherwood`/`aetherleaf`, подземные блоки `aetherstone` и `crystal`, поверхность покрыта `aethergrass`. Это отдельная зона с собственными текстурами (`aether`/`aetherleaf`, alpha 40%).

## Примечания и сложности

- Прозрачность и alphaTest требуются только для `water`, `ice`, `leaves`, `aetherleaf`, остальные блоки рендерятся непрозрачными.
- `chunkSize` равен `14`, `renderDistance` и `maxLoadedChunks` рассчитываются из формулы геометрии (`1 + 3*r*(r+1)`).
- При генерации деревьев используется `blockMap`, чтобы не разрешать наложения; `treeMultiplier` меняет вероятность для каждого биома.
- Для Dark Forest и Aether требуется соседство и условия («втроение»), так что эти биомы сами по себе создают границы без постобработки.

Это основной справочник по атласу и биомам; для обновлений добавляй информацию в этот файл и в `docs/structures.md`.
